<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 TMLE | R Guide for TMLE in Medical Research</title>
  <meta name="description" content="Intro to R." />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 TMLE | R Guide for TMLE in Medical Research" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Intro to R." />
  <meta name="github-repo" content="ehsanx/intro2R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 TMLE | R Guide for TMLE in Medical Research" />
  
  <meta name="twitter:description" content="Intro to R." />
  

<meta name="author" content="Ehsan Karim &amp; Hanna Frank" />


<meta name="date" content="2021-08-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="iptw-using-ml.html"/>
<link rel="next" href="pre-packaged-software.html"/>
<script src="libs/header-attrs-2.9/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Global") elem.value = "Show Global";
    else elem.value = "Hide Global";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Global" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">TMLE in Medical Research</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#background"><i class="fa fa-check"></i>Background</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#goal"><i class="fa fa-check"></i>Goal</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#philosophy"><i class="fa fa-check"></i>Philosophy</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#pre-requisites"><i class="fa fa-check"></i>Pre-requisites</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#version-history"><i class="fa fa-check"></i>Version history</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributor-list"><i class="fa fa-check"></i>Contributor list</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="rhc-data-description.html"><a href="rhc-data-description.html"><i class="fa fa-check"></i><b>1</b> RHC data description</a>
<ul>
<li class="chapter" data-level="1.1" data-path="rhc-data-description.html"><a href="rhc-data-description.html#data-download"><i class="fa fa-check"></i><b>1.1</b> Data download</a></li>
<li class="chapter" data-level="1.2" data-path="rhc-data-description.html"><a href="rhc-data-description.html#analytic-data"><i class="fa fa-check"></i><b>1.2</b> Analytic data</a></li>
<li class="chapter" data-level="1.3" data-path="rhc-data-description.html"><a href="rhc-data-description.html#notations"><i class="fa fa-check"></i><b>1.3</b> Notations</a></li>
<li class="chapter" data-level="1.4" data-path="rhc-data-description.html"><a href="rhc-data-description.html#variables"><i class="fa fa-check"></i><b>1.4</b> Variables</a></li>
<li class="chapter" data-level="1.5" data-path="rhc-data-description.html"><a href="rhc-data-description.html#table-1-stratified-by-rhc-exposure"><i class="fa fa-check"></i><b>1.5</b> Table 1 stratified by RHC exposure</a></li>
<li class="chapter" data-level="1.6" data-path="rhc-data-description.html"><a href="rhc-data-description.html#basic-regression-analysis"><i class="fa fa-check"></i><b>1.6</b> Basic regression analysis</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="rhc-data-description.html"><a href="rhc-data-description.html#crude-analysis"><i class="fa fa-check"></i><b>1.6.1</b> Crude analysis</a></li>
<li class="chapter" data-level="1.6.2" data-path="rhc-data-description.html"><a href="rhc-data-description.html#adjusted-analysis"><i class="fa fa-check"></i><b>1.6.2</b> Adjusted analysis</a></li>
<li class="chapter" data-level="1.6.3" data-path="rhc-data-description.html"><a href="rhc-data-description.html#regression-diagnostics"><i class="fa fa-check"></i><b>1.6.3</b> Regression diagnostics</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="rhc-data-description.html"><a href="rhc-data-description.html#comparison-with-literature"><i class="fa fa-check"></i><b>1.7</b> Comparison with literature</a>
<ul>
<li class="chapter" data-level="1.7.1" data-path="rhc-data-description.html"><a href="rhc-data-description.html#psm-in-rhc-data"><i class="fa fa-check"></i><b>1.7.1</b> PSM in RHC data</a></li>
<li class="chapter" data-level="1.7.2" data-path="rhc-data-description.html"><a href="rhc-data-description.html#tmle-in-rhc-data"><i class="fa fa-check"></i><b>1.7.2</b> TMLE in RHC data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="g-computation.html"><a href="g-computation.html"><i class="fa fa-check"></i><b>2</b> G-computation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="g-computation.html"><a href="g-computation.html#closer-look-at-the-data"><i class="fa fa-check"></i><b>2.1</b> Closer look at the data</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="g-computation.html"><a href="g-computation.html#view-data-from-6-participants"><i class="fa fa-check"></i><b>2.1.1</b> View data from 6 participants</a></li>
<li class="chapter" data-level="2.1.2" data-path="g-computation.html"><a href="g-computation.html#new-notations"><i class="fa fa-check"></i><b>2.1.2</b> New notations</a></li>
<li class="chapter" data-level="2.1.3" data-path="g-computation.html"><a href="g-computation.html#restructure-the-data-to-estimate-treatment-effect"><i class="fa fa-check"></i><b>2.1.3</b> Restructure the data to estimate treatment effect</a></li>
<li class="chapter" data-level="2.1.4" data-path="g-computation.html"><a href="g-computation.html#treat-the-problem-as-a-missing-value-problem"><i class="fa fa-check"></i><b>2.1.4</b> Treat the problem as a missing value problem</a></li>
<li class="chapter" data-level="2.1.5" data-path="g-computation.html"><a href="g-computation.html#impute-better-value"><i class="fa fa-check"></i><b>2.1.5</b> Impute better value?</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="g-computation.html"><a href="g-computation.html#use-regression-for-predicting-outcome"><i class="fa fa-check"></i><b>2.2</b> Use Regression for predicting outcome</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="g-computation.html"><a href="g-computation.html#predict-outcome-for-treated"><i class="fa fa-check"></i><b>2.2.1</b> Predict outcome for treated</a></li>
<li class="chapter" data-level="2.2.2" data-path="g-computation.html"><a href="g-computation.html#look-at-the-predicted-outcome-data-for-treated"><i class="fa fa-check"></i><b>2.2.2</b> Look at the predicted outcome data for treated</a></li>
<li class="chapter" data-level="2.2.3" data-path="g-computation.html"><a href="g-computation.html#predict-outcome-for-untreated"><i class="fa fa-check"></i><b>2.2.3</b> Predict outcome for untreated</a></li>
<li class="chapter" data-level="2.2.4" data-path="g-computation.html"><a href="g-computation.html#look-at-the-predicted-outcome-data-for-untreated"><i class="fa fa-check"></i><b>2.2.4</b> Look at the predicted outcome data for untreated</a></li>
<li class="chapter" data-level="2.2.5" data-path="g-computation.html"><a href="g-computation.html#look-at-the-predicted-outcome-data-for-all"><i class="fa fa-check"></i><b>2.2.5</b> Look at the predicted outcome data for all!</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="g-computation.html"><a href="g-computation.html#parametric-g-computation"><i class="fa fa-check"></i><b>2.3</b> Parametric G-computation</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="g-computation.html"><a href="g-computation.html#steps"><i class="fa fa-check"></i><b>2.3.1</b> Steps</a></li>
<li class="chapter" data-level="2.3.2" data-path="g-computation.html"><a href="g-computation.html#treatment-effect-estimate"><i class="fa fa-check"></i><b>2.3.2</b> Treatment effect estimate</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="g-computation.html"><a href="g-computation.html#estimating-the-confidence-intervals"><i class="fa fa-check"></i><b>2.4</b> Estimating the confidence intervals</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html"><i class="fa fa-check"></i><b>3</b> G-computation using ML</a>
<ul>
<li class="chapter" data-level="3.1" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-using-regression-tree"><i class="fa fa-check"></i><b>3.1</b> G-comp using Regression tree</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#a-tree-based-algorithm"><i class="fa fa-check"></i><b>3.1.1</b> A tree based algorithm</a></li>
<li class="chapter" data-level="3.1.2" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#cross-validation"><i class="fa fa-check"></i><b>3.1.2</b> Cross-validation</a></li>
<li class="chapter" data-level="3.1.3" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-step-2-extract-outcome-prediction-as-if-everyone-is-treated"><i class="fa fa-check"></i><b>3.1.3</b> G-comp step 2: Extract outcome prediction as if everyone is treated</a></li>
<li class="chapter" data-level="3.1.4" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-step-3-extract-outcome-prediction-as-if-everyone-is-untreated"><i class="fa fa-check"></i><b>3.1.4</b> G-comp step 3: Extract outcome prediction as if everyone is untreated</a></li>
<li class="chapter" data-level="3.1.5" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-step-4-treatment-effect-estimate"><i class="fa fa-check"></i><b>3.1.5</b> G-comp step 4: Treatment effect estimate</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-using-regularized-methods"><i class="fa fa-check"></i><b>3.2</b> G-comp using regularized methods</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#a-regularized-model"><i class="fa fa-check"></i><b>3.2.1</b> A regularized model</a></li>
<li class="chapter" data-level="3.2.2" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-step-2-extract-outcome-prediction-as-if-everyone-is-treated-1"><i class="fa fa-check"></i><b>3.2.2</b> G-comp step 2: Extract outcome prediction as if everyone is treated</a></li>
<li class="chapter" data-level="3.2.3" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-step-3-extract-outcome-prediction-as-if-everyone-is-untreated-1"><i class="fa fa-check"></i><b>3.2.3</b> G-comp step 3: Extract outcome prediction as if everyone is untreated</a></li>
<li class="chapter" data-level="3.2.4" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-step-3-treatment-effect-estimate"><i class="fa fa-check"></i><b>3.2.4</b> G-comp step 3: Treatment effect estimate</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-using-superlearner"><i class="fa fa-check"></i><b>3.3</b> G-comp using SuperLearner</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#steps-1"><i class="fa fa-check"></i><b>3.3.1</b> Steps</a></li>
<li class="chapter" data-level="3.3.2" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-step-2-extract-outcome-prediction-as-if-everyone-is-treated-2"><i class="fa fa-check"></i><b>3.3.2</b> G-comp step 2: Extract outcome prediction as if everyone is treated</a></li>
<li class="chapter" data-level="3.3.3" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-step-3-extract-outcome-prediction-as-if-everyone-is-untreated-2"><i class="fa fa-check"></i><b>3.3.3</b> G-comp step 3: Extract outcome prediction as if everyone is untreated</a></li>
<li class="chapter" data-level="3.3.4" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#g-comp-step-3-treatment-effect-estimate-1"><i class="fa fa-check"></i><b>3.3.4</b> G-comp step 3: Treatment effect estimate</a></li>
<li class="chapter" data-level="3.3.5" data-path="g-computation-using-ml.html"><a href="g-computation-using-ml.html#additional-details-for-sl"><i class="fa fa-check"></i><b>3.3.5</b> Additional details for SL</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="iptw.html"><a href="iptw.html"><i class="fa fa-check"></i><b>4</b> IPTW</a>
<ul>
<li class="chapter" data-level="4.1" data-path="iptw.html"><a href="iptw.html#iptw-steps"><i class="fa fa-check"></i><b>4.1</b> IPTW steps</a></li>
<li class="chapter" data-level="4.2" data-path="iptw.html"><a href="iptw.html#step-1-exposure-modelling"><i class="fa fa-check"></i><b>4.2</b> Step 1: exposure modelling</a></li>
<li class="chapter" data-level="4.3" data-path="iptw.html"><a href="iptw.html#step-2-convert-ps-to-ipw"><i class="fa fa-check"></i><b>4.3</b> Step 2: Convert PS to IPW</a></li>
<li class="chapter" data-level="4.4" data-path="iptw.html"><a href="iptw.html#step-3-balance-checking"><i class="fa fa-check"></i><b>4.4</b> Step 3: Balance checking</a></li>
<li class="chapter" data-level="4.5" data-path="iptw.html"><a href="iptw.html#step-4-outcome-modelling"><i class="fa fa-check"></i><b>4.5</b> Step 4: outcome modelling</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="iptw-using-ml.html"><a href="iptw-using-ml.html"><i class="fa fa-check"></i><b>5</b> IPTW using ML</a>
<ul>
<li class="chapter" data-level="5.1" data-path="iptw-using-ml.html"><a href="iptw-using-ml.html#iptw-steps-from-sl"><i class="fa fa-check"></i><b>5.1</b> IPTW Steps from SL</a></li>
<li class="chapter" data-level="5.2" data-path="iptw-using-ml.html"><a href="iptw-using-ml.html#step-1-exposure-modelling-1"><i class="fa fa-check"></i><b>5.2</b> Step 1: exposure modelling</a></li>
<li class="chapter" data-level="5.3" data-path="iptw-using-ml.html"><a href="iptw-using-ml.html#step-2-convert-ps-to-ipw-1"><i class="fa fa-check"></i><b>5.3</b> Step 2: Convert PS to IPW</a></li>
<li class="chapter" data-level="5.4" data-path="iptw-using-ml.html"><a href="iptw-using-ml.html#step-3-balance-checking-1"><i class="fa fa-check"></i><b>5.4</b> Step 3: Balance checking</a></li>
<li class="chapter" data-level="5.5" data-path="iptw-using-ml.html"><a href="iptw-using-ml.html#step-4-outcome-modelling-1"><i class="fa fa-check"></i><b>5.5</b> Step 4: outcome modelling</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="iptw-using-ml.html"><a href="iptw-using-ml.html#crude"><i class="fa fa-check"></i><b>5.5.1</b> Crude</a></li>
<li class="chapter" data-level="5.5.2" data-path="iptw-using-ml.html"><a href="iptw-using-ml.html#adjusted"><i class="fa fa-check"></i><b>5.5.2</b> Adjusted</a></li>
<li class="chapter" data-level="5.5.3" data-path="iptw-using-ml.html"><a href="iptw-using-ml.html#adjusted-from-package"><i class="fa fa-check"></i><b>5.5.3</b> Adjusted (from package)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="tmle.html"><a href="tmle.html"><i class="fa fa-check"></i><b>6</b> TMLE</a>
<ul>
<li class="chapter" data-level="6.1" data-path="tmle.html"><a href="tmle.html#doubly-robust-estimators"><i class="fa fa-check"></i><b>6.1</b> Doubly robust estimators</a></li>
<li class="chapter" data-level="6.2" data-path="tmle.html"><a href="tmle.html#tmle-1"><i class="fa fa-check"></i><b>6.2</b> TMLE</a></li>
<li class="chapter" data-level="6.3" data-path="tmle.html"><a href="tmle.html#tmle-steps"><i class="fa fa-check"></i><b>6.3</b> TMLE Steps</a></li>
<li class="chapter" data-level="6.4" data-path="tmle.html"><a href="tmle.html#step-1-transformation-of-y"><i class="fa fa-check"></i><b>6.4</b> Step 1: Transformation of Y</a></li>
<li class="chapter" data-level="6.5" data-path="tmle.html"><a href="tmle.html#step-2-initial-g-comp-estimate"><i class="fa fa-check"></i><b>6.5</b> Step 2: Initial G-comp estimate</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="tmle.html"><a href="tmle.html#get-predictions-under-both-treatments-a-0-and-1"><i class="fa fa-check"></i><b>6.5.1</b> Get predictions under both treatments <span class="math inline">\(A = 0\)</span> and <span class="math inline">\(1\)</span></a></li>
<li class="chapter" data-level="6.5.2" data-path="tmle.html"><a href="tmle.html#get-initial-treatment-effect-estimate"><i class="fa fa-check"></i><b>6.5.2</b> Get initial treatment effect estimate</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="tmle.html"><a href="tmle.html#step-3-ps-model"><i class="fa fa-check"></i><b>6.6</b> Step 3: PS model</a></li>
<li class="chapter" data-level="6.7" data-path="tmle.html"><a href="tmle.html#step-4-estimate-h"><i class="fa fa-check"></i><b>6.7</b> Step 4: Estimate <span class="math inline">\(H\)</span></a></li>
<li class="chapter" data-level="6.8" data-path="tmle.html"><a href="tmle.html#step-5-estimate-epsilon"><i class="fa fa-check"></i><b>6.8</b> Step 5: Estimate <span class="math inline">\(\epsilon\)</span></a>
<ul>
<li class="chapter" data-level="6.8.1" data-path="tmle.html"><a href="tmle.html#hatepsilon-hatepsilon_0-and-hatepsilon_1"><i class="fa fa-check"></i><b>6.8.1</b> <span class="math inline">\(\hat\epsilon\)</span> = <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span></a></li>
<li class="chapter" data-level="6.8.2" data-path="tmle.html"><a href="tmle.html#only-1-hatepsilon"><i class="fa fa-check"></i><b>6.8.2</b> Only 1 <span class="math inline">\(\hat\epsilon\)</span></a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="tmle.html"><a href="tmle.html#step-6-update"><i class="fa fa-check"></i><b>6.9</b> Step 6: Update</a>
<ul>
<li class="chapter" data-level="6.9.1" data-path="tmle.html"><a href="tmle.html#hatepsilon-hatepsilon_0-and-hatepsilon_1-1"><i class="fa fa-check"></i><b>6.9.1</b> <span class="math inline">\(\hat\epsilon\)</span> = <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span></a></li>
<li class="chapter" data-level="6.9.2" data-path="tmle.html"><a href="tmle.html#only-1-hatepsilon-1"><i class="fa fa-check"></i><b>6.9.2</b> Only 1 <span class="math inline">\(\hat\epsilon\)</span></a></li>
</ul></li>
<li class="chapter" data-level="6.10" data-path="tmle.html"><a href="tmle.html#step-7-effect-estimate"><i class="fa fa-check"></i><b>6.10</b> Step 7: Effect estimate</a>
<ul>
<li class="chapter" data-level="6.10.1" data-path="tmle.html"><a href="tmle.html#hatepsilon-hatepsilon_0-and-hatepsilon_1-2"><i class="fa fa-check"></i><b>6.10.1</b> <span class="math inline">\(\hat\epsilon\)</span> = <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span></a></li>
<li class="chapter" data-level="6.10.2" data-path="tmle.html"><a href="tmle.html#only-1-hatepsilon-2"><i class="fa fa-check"></i><b>6.10.2</b> Only 1 <span class="math inline">\(\hat\epsilon\)</span></a></li>
</ul></li>
<li class="chapter" data-level="6.11" data-path="tmle.html"><a href="tmle.html#step-8-rescale-effect-estimate"><i class="fa fa-check"></i><b>6.11</b> Step 8: Rescale effect estimate</a>
<ul>
<li class="chapter" data-level="6.11.1" data-path="tmle.html"><a href="tmle.html#hatepsilon-hatepsilon_0-and-hatepsilon_1-3"><i class="fa fa-check"></i><b>6.11.1</b> <span class="math inline">\(\hat\epsilon\)</span> = <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span></a></li>
<li class="chapter" data-level="6.11.2" data-path="tmle.html"><a href="tmle.html#only-1-hatepsilon-3"><i class="fa fa-check"></i><b>6.11.2</b> Only 1 <span class="math inline">\(\hat\epsilon\)</span></a></li>
</ul></li>
<li class="chapter" data-level="6.12" data-path="tmle.html"><a href="tmle.html#step-9-confidence-interval-estimation"><i class="fa fa-check"></i><b>6.12</b> Step 9: Confidence interval estimation</a>
<ul>
<li class="chapter" data-level="6.12.1" data-path="tmle.html"><a href="tmle.html#hatepsilon-hatepsilon_0-and-hatepsilon_1-4"><i class="fa fa-check"></i><b>6.12.1</b> <span class="math inline">\(\hat\epsilon\)</span> = <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span></a></li>
<li class="chapter" data-level="6.12.2" data-path="tmle.html"><a href="tmle.html#only-1-hatepsilon-4"><i class="fa fa-check"></i><b>6.12.2</b> Only 1 <span class="math inline">\(\hat\epsilon\)</span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="pre-packaged-software.html"><a href="pre-packaged-software.html"><i class="fa fa-check"></i><b>7</b> Pre-packaged software</a>
<ul>
<li class="chapter" data-level="7.1" data-path="pre-packaged-software.html"><a href="pre-packaged-software.html#tmle-2"><i class="fa fa-check"></i><b>7.1</b> tmle</a></li>
<li class="chapter" data-level="7.2" data-path="pre-packaged-software.html"><a href="pre-packaged-software.html#tmle-reduced-computation"><i class="fa fa-check"></i><b>7.2</b> tmle (reduced computation)</a></li>
<li class="chapter" data-level="7.3" data-path="pre-packaged-software.html"><a href="pre-packaged-software.html#sl3-optional"><i class="fa fa-check"></i><b>7.3</b> sl3 (optional)</a></li>
<li class="chapter" data-level="7.4" data-path="pre-packaged-software.html"><a href="pre-packaged-software.html#rhc-results"><i class="fa fa-check"></i><b>7.4</b> RHC results</a></li>
<li class="chapter" data-level="7.5" data-path="pre-packaged-software.html"><a href="pre-packaged-software.html#other-packages"><i class="fa fa-check"></i><b>7.5</b> Other packages</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="final-words.html"><a href="final-words.html"><i class="fa fa-check"></i><b>8</b> Final Words</a>
<ul>
<li class="chapter" data-level="8.1" data-path="final-words.html"><a href="final-words.html#select-variables-judiciously"><i class="fa fa-check"></i><b>8.1</b> Select variables judiciously</a></li>
<li class="chapter" data-level="8.2" data-path="final-words.html"><a href="final-words.html#why-sl-and-tmle"><i class="fa fa-check"></i><b>8.2</b> Why SL and TMLE</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="final-words.html"><a href="final-words.html#prediction-goal"><i class="fa fa-check"></i><b>8.2.1</b> Prediction goal</a></li>
<li class="chapter" data-level="8.2.2" data-path="final-words.html"><a href="final-words.html#causal-inference"><i class="fa fa-check"></i><b>8.2.2</b> Causal inference</a></li>
<li class="chapter" data-level="8.2.3" data-path="final-words.html"><a href="final-words.html#identifiability-assumptions"><i class="fa fa-check"></i><b>8.2.3</b> Identifiability assumptions</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="final-words.html"><a href="final-words.html#further-reading"><i class="fa fa-check"></i><b>8.3</b> Further reading</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="final-words.html"><a href="final-words.html#key-articles"><i class="fa fa-check"></i><b>8.3.1</b> Key articles</a></li>
<li class="chapter" data-level="8.3.2" data-path="final-words.html"><a href="final-words.html#additional-readings"><i class="fa fa-check"></i><b>8.3.2</b> Additional readings</a></li>
<li class="chapter" data-level="8.3.3" data-path="final-words.html"><a href="final-words.html#workshops"><i class="fa fa-check"></i><b>8.3.3</b> Workshops</a></li>
<li class="chapter" data-level="8.3.4" data-path="final-words.html"><a href="final-words.html#recorded-webinars"><i class="fa fa-check"></i><b>8.3.4</b> Recorded webinars</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://ehsank.com/" target="blank">Contact</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R Guide for TMLE in Medical Research</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tmle" class="section level1" number="6">
<h1><span class="header-section-number">Chapter 6</span> TMLE</h1>
<div id="doubly-robust-estimators" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Doubly robust estimators</h2>
<p>Now that we have covered</p>
<ul>
<li>outcome models (e.g., G-computation) and</li>
<li>exposure models (e.g., propensity score models),</li>
</ul>
<p>let us talk about doubly robust (DR) estimators. DR has several important properties:</p>
<ul>
<li>They use information from both
<ul>
<li>the exposure and</li>
<li>the outcome models.</li>
</ul></li>
<li>They provide a <strong>consistent estimator</strong> if either of the above mentioned models is correctly specified.
<ul>
<li>consistent estimator means as the sample size increases, distribution of the estimates gets concentrated near the true parameter</li>
</ul></li>
<li>They provide an <strong>efficient estimator</strong> if both the exposure and the outcome model are correctly specified.
<ul>
<li>efficient estimator means estimates approximates the true parameter in terms of a chosen loss function (e.g., could be RMSE).</li>
</ul></li>
</ul>
</div>
<div id="tmle-1" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> TMLE</h2>
<p>Targeted Maximum Likelihood Estimation (TMLE) is a DR method, using</p>
<ul>
<li>an initial estimate from the outcome model (G-computation)</li>
<li>the propensity score (exposure) model to improve.</li>
</ul>
<p>In addition to being DR, TMLE has several other desirable properties:</p>
<ul>
<li>It allows the use of <strong>data-adaptive algorithms</strong> like machine learning without sacrificing interpretability.
<ul>
<li>ML is only used in intermediary steps to develop the estimator, so the optimization and interpretation of the estimator as a whole remains intact.</li>
<li>The use of machine learning can help mitigate model misspecification.</li>
</ul></li>
<li>It has been shown to outperform other methods, particularly in <strong>sparse data settings</strong>.</li>
</ul>
</div>
<div id="tmle-steps" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> TMLE Steps</h2>
<p>According to <span class="citation"><a href="#ref-luque2018targeted" role="doc-biblioref">Luque-Fernandez et al.</a> (<a href="#ref-luque2018targeted" role="doc-biblioref">2018</a>)</span>, we need to the following steps (2-7) for obtaining point estimates when dealing with binary outcome. But as we are dealing with continuous outcome, we need an added transformation step at the beginning, and also at the end.</p>
<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Step 1</td>
<td>Transformation of continuous outcome variable</td>
</tr>
<tr class="even">
<td>Step 2</td>
<td>Predict from initial outcome modelling: G-computation</td>
</tr>
<tr class="odd">
<td>Step 3</td>
<td>Predict from propensity score model</td>
</tr>
<tr class="even">
<td>Step 4</td>
<td>Estimate clever covariate <span class="math inline">\(H\)</span></td>
</tr>
<tr class="odd">
<td>Step 5</td>
<td>Estimate fluctuation parameter <span class="math inline">\(\epsilon\)</span></td>
</tr>
<tr class="even">
<td>Step 6</td>
<td>Update the initial outcome model prediction based on targeted adjustment of the initial predictions using the PS model</td>
</tr>
<tr class="odd">
<td>Step 7</td>
<td>Find treatment effect estimate</td>
</tr>
<tr class="even">
<td>Step 8</td>
<td>Transform back the treatment effect estimate in the original outcome scale</td>
</tr>
<tr class="odd">
<td>Step 9</td>
<td>Confidence interval estimation based on closed form formula</td>
</tr>
</tbody>
</table>
<ul>
<li>We will go through the steps of TMLE one-by-one, using the RHC dataset presented in previous chapters.</li>
<li>As a reminder, the exposure we are considering is RHC (right heart catheterization) and the outcome of interest is length of stay in the hospital.</li>
</ul>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="tmle.html#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the data saved at the last chapter</span></span>
<span id="cb208-2"><a href="tmle.html#cb208-2" aria-hidden="true" tabindex="-1"></a>ObsData <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">&quot;data/rhcAnalytic.RDS&quot;</span>)</span></code></pre></div>
</div>
<div id="step-1-transformation-of-y" class="section level2" number="6.4">
<h2><span class="header-section-number">6.4</span> Step 1: Transformation of Y</h2>
<p>In our example, the outcome is continuous.</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="tmle.html#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>Y)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    2.00    7.00   14.00   21.56   25.00  394.00</code></pre>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="tmle.html#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(ObsData<span class="sc">$</span>Y), <span class="at">main =</span> <span class="st">&quot;Observed Y&quot;</span>)</span></code></pre></div>
<p><img src="TMLEw_files/figure-html/transf1-1.png" width="672" /></p>
<div class="rmdcomment">
<p>
General recommendation is to <strong>transform</strong> continuous outcome to be within the range [0,1] <span class="citation"><span class="citation">(<a href="#ref-gruber2010targeted" role="doc-biblioref">Susan Gruber and Laan 2010</a>)</span></span>.
</p>
</div>
<!--- However, it is recommended that even with continuous outcomes we use a log-likelihood loss function for the maximum likelihood estimation, as we would with a binary outcome.  --->
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="tmle.html#cb212-1" aria-hidden="true" tabindex="-1"></a>min.Y <span class="ot">&lt;-</span> <span class="fu">min</span>(ObsData<span class="sc">$</span>Y)</span>
<span id="cb212-2"><a href="tmle.html#cb212-2" aria-hidden="true" tabindex="-1"></a>max.Y <span class="ot">&lt;-</span> <span class="fu">max</span>(ObsData<span class="sc">$</span>Y)</span>
<span id="cb212-3"><a href="tmle.html#cb212-3" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>Y.bounded <span class="ot">&lt;-</span> (ObsData<span class="sc">$</span>Y<span class="sc">-</span>min.Y)<span class="sc">/</span>(max.Y<span class="sc">-</span>min.Y)</span></code></pre></div>
<p>Check the range of our transformed outcome variable</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="tmle.html#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>Y.bounded)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## 0.00000 0.01276 0.03061 0.04990 0.05867 1.00000</code></pre>
</div>
<div id="step-2-initial-g-comp-estimate" class="section level2" number="6.5">
<h2><span class="header-section-number">6.5</span> Step 2: Initial G-comp estimate</h2>
<div class="rmdcomment">
<p>
We construct our outcome model, and make our initial predictions.
</p>
</div>
<p>For this step, we will use <strong>SuperLearner</strong>. This requires no apriori assumptions about the structure of our outcome model.</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="tmle.html#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="cb215-2"><a href="tmle.html#cb215-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb215-3"><a href="tmle.html#cb215-3" aria-hidden="true" tabindex="-1"></a>ObsData.noY <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(ObsData, <span class="sc">!</span><span class="fu">c</span>(Y,Y.bounded))</span>
<span id="cb215-4"><a href="tmle.html#cb215-4" aria-hidden="true" tabindex="-1"></a>Y.fit.sl <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(<span class="at">Y=</span>ObsData<span class="sc">$</span>Y.bounded, </span>
<span id="cb215-5"><a href="tmle.html#cb215-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">X=</span>ObsData.noY, </span>
<span id="cb215-6"><a href="tmle.html#cb215-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cvControl =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">3</span>),</span>
<span id="cb215-7"><a href="tmle.html#cb215-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">SL.library=</span><span class="fu">c</span>(<span class="st">&quot;SL.glm&quot;</span>, </span>
<span id="cb215-8"><a href="tmle.html#cb215-8" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&quot;SL.glmnet&quot;</span>, </span>
<span id="cb215-9"><a href="tmle.html#cb215-9" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&quot;SL.xgboost&quot;</span>),</span>
<span id="cb215-10"><a href="tmle.html#cb215-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">method=</span><span class="st">&quot;method.CC_nloglik&quot;</span>, </span>
<span id="cb215-11"><a href="tmle.html#cb215-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="tmle.html#cb216-1" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>init.Pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.fit.sl, <span class="at">newdata =</span> ObsData.noY, </span>
<span id="cb216-2"><a href="tmle.html#cb216-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)<span class="sc">$</span>pred</span>
<span id="cb216-3"><a href="tmle.html#cb216-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-4"><a href="tmle.html#cb216-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>init.Pred)</span></code></pre></div>
<pre><code>##        V1         
##  Min.   :0.00100  
##  1st Qu.:0.03723  
##  Median :0.04948  
##  Mean   :0.04877  
##  3rd Qu.:0.06067  
##  Max.   :0.13659</code></pre>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="tmle.html#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co"># alternatively, we could write</span></span>
<span id="cb218-2"><a href="tmle.html#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ObsData$init.Pred &lt;- Y.fit.sl$SL.predict</span></span></code></pre></div>
<ul>
<li>We will use these initial prediction values later.</li>
</ul>
<div class="rmdcomment">
<p>
<span class="math inline"><span class="math inline">\(Q^0(A,L)\)</span></span> is often used to represent the predictions from initial G-comp model.
</p>
</div>
<div id="get-predictions-under-both-treatments-a-0-and-1" class="section level3" number="6.5.1">
<h3><span class="header-section-number">6.5.1</span> Get predictions under both treatments <span class="math inline">\(A = 0\)</span> and <span class="math inline">\(1\)</span></h3>
<ul>
<li>We could estimate the treatment effect from this initial model.</li>
<li>We will need the <span class="math inline">\(Q^0(A=1,L)\)</span> and <span class="math inline">\(Q^0(A=0,L)\)</span> predictions later.</li>
<li><span class="math inline">\(Q^0(A=1,L)\)</span> predictions:</li>
</ul>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="tmle.html#cb219-1" aria-hidden="true" tabindex="-1"></a>ObsData.noY<span class="sc">$</span>A <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb219-2"><a href="tmle.html#cb219-2" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>Pred.Y1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.fit.sl, <span class="at">newdata =</span> ObsData.noY, </span>
<span id="cb219-3"><a href="tmle.html#cb219-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)<span class="sc">$</span>pred</span>
<span id="cb219-4"><a href="tmle.html#cb219-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>Pred.Y1)</span></code></pre></div>
<pre><code>##        V1         
##  Min.   :0.00100  
##  1st Qu.:0.04240  
##  Median :0.05429  
##  Mean   :0.05322  
##  3rd Qu.:0.06446  
##  Max.   :0.13659</code></pre>
<ul>
<li><span class="math inline">\(Q^0(A=0,L)\)</span> predictions:</li>
</ul>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="tmle.html#cb221-1" aria-hidden="true" tabindex="-1"></a>ObsData.noY<span class="sc">$</span>A <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb221-2"><a href="tmle.html#cb221-2" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>Pred.Y0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(Y.fit.sl, <span class="at">newdata =</span> ObsData.noY, </span>
<span id="cb221-3"><a href="tmle.html#cb221-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)<span class="sc">$</span>pred</span>
<span id="cb221-4"><a href="tmle.html#cb221-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>Pred.Y0)</span></code></pre></div>
<pre><code>##        V1         
##  Min.   :0.00100  
##  1st Qu.:0.03524  
##  Median :0.04708  
##  Mean   :0.04609  
##  3rd Qu.:0.05734  
##  Max.   :0.12652</code></pre>
</div>
<div id="get-initial-treatment-effect-estimate" class="section level3" number="6.5.2">
<h3><span class="header-section-number">6.5.2</span> Get initial treatment effect estimate</h3>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="tmle.html#cb223-1" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>Pred.TE <span class="ot">&lt;-</span> ObsData<span class="sc">$</span>Pred.Y1 <span class="sc">-</span> ObsData<span class="sc">$</span>Pred.Y0   </span></code></pre></div>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="tmle.html#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>Pred.TE) </span></code></pre></div>
<pre><code>##        V1           
##  Min.   :-0.010333  
##  1st Qu.: 0.006682  
##  Median : 0.007071  
##  Mean   : 0.007134  
##  3rd Qu.: 0.007541  
##  Max.   : 0.021592</code></pre>
</div>
</div>
<div id="step-3-ps-model" class="section level2" number="6.6">
<h2><span class="header-section-number">6.6</span> Step 3: PS model</h2>
<p>At this point, we have our initial estimate and now want to perform our targeted improvement.</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="tmle.html#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="cb226-2"><a href="tmle.html#cb226-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">124</span>)</span>
<span id="cb226-3"><a href="tmle.html#cb226-3" aria-hidden="true" tabindex="-1"></a>ObsData.noYA <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(ObsData, <span class="sc">!</span><span class="fu">c</span>(Y,Y.bounded,</span>
<span id="cb226-4"><a href="tmle.html#cb226-4" aria-hidden="true" tabindex="-1"></a>                                          A,init.Pred,</span>
<span id="cb226-5"><a href="tmle.html#cb226-5" aria-hidden="true" tabindex="-1"></a>                                          Pred.Y1,Pred.Y0,</span>
<span id="cb226-6"><a href="tmle.html#cb226-6" aria-hidden="true" tabindex="-1"></a>                                          Pred.TE))</span>
<span id="cb226-7"><a href="tmle.html#cb226-7" aria-hidden="true" tabindex="-1"></a>PS.fit.SL <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(<span class="at">Y=</span>ObsData<span class="sc">$</span>A, </span>
<span id="cb226-8"><a href="tmle.html#cb226-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">X=</span>ObsData.noYA, </span>
<span id="cb226-9"><a href="tmle.html#cb226-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cvControl =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">3</span>),</span>
<span id="cb226-10"><a href="tmle.html#cb226-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">SL.library=</span><span class="fu">c</span>(<span class="st">&quot;SL.glm&quot;</span>, </span>
<span id="cb226-11"><a href="tmle.html#cb226-11" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&quot;SL.glmnet&quot;</span>, </span>
<span id="cb226-12"><a href="tmle.html#cb226-12" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&quot;SL.xgboost&quot;</span>),</span>
<span id="cb226-13"><a href="tmle.html#cb226-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">method=</span><span class="st">&quot;method.CC_nloglik&quot;</span>,</span>
<span id="cb226-14"><a href="tmle.html#cb226-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">family=</span><span class="st">&quot;binomial&quot;</span>)  </span></code></pre></div>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="tmle.html#cb227-1" aria-hidden="true" tabindex="-1"></a>all.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(PS.fit.SL, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb227-2"><a href="tmle.html#cb227-2" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>PS.SL <span class="ot">&lt;-</span> all.pred<span class="sc">$</span>pred </span></code></pre></div>
<div class="rmdcomment">
<p>
These propensity score predictions (<code>PS.SL</code>) are represented as <span class="math inline"><span class="math inline">\(g(A_i=1|L_i)\)</span></span>.
</p>
</div>
<ul>
<li>We can estimate <span class="math inline">\(g(A_i=0|L_i)\)</span> as <span class="math inline">\(1 - g(A_i=1|L_i)\)</span> or <code>1 - PS.SL</code>.</li>
</ul>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="tmle.html#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>PS.SL)</span></code></pre></div>
<pre><code>##        V1          
##  Min.   :0.002806  
##  1st Qu.:0.133409  
##  Median :0.329181  
##  Mean   :0.375143  
##  3rd Qu.:0.596584  
##  Max.   :0.983057</code></pre>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="tmle.html#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tapply</span>(ObsData<span class="sc">$</span>PS.SL, ObsData<span class="sc">$</span>A, summary)</span></code></pre></div>
<pre><code>## $`0`
##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## 0.002806 0.079637 0.177020 0.219962 0.327519 0.866585 
## 
## $`1`
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## 0.03745 0.49045 0.65384 0.62745 0.78263 0.98306</code></pre>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="tmle.html#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(ObsData<span class="sc">$</span>PS.SL[ObsData<span class="sc">$</span>A<span class="sc">==</span><span class="dv">0</span>]), </span>
<span id="cb232-2"><a href="tmle.html#cb232-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">main =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb232-3"><a href="tmle.html#cb232-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(ObsData<span class="sc">$</span>PS.SL[ObsData<span class="sc">$</span>A<span class="sc">==</span><span class="dv">1</span>]), </span>
<span id="cb232-4"><a href="tmle.html#cb232-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb232-5"><a href="tmle.html#cb232-5" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topright&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;No RHC&quot;</span>,<span class="st">&quot;RHC&quot;</span>), </span>
<span id="cb232-6"><a href="tmle.html#cb232-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="at">lty=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) </span></code></pre></div>
<p><img src="TMLEw_files/figure-html/ipw2psx2btmle-1.png" width="672" /></p>
</div>
<div id="step-4-estimate-h" class="section level2" number="6.7">
<h2><span class="header-section-number">6.7</span> Step 4: Estimate <span class="math inline">\(H\)</span></h2>
<div class="rmdcomment">
<p>
Clever covariate <span class="math inline"><span class="math inline">\(H(A_i, L_i) = \frac{I(A_i=1)}{g(A_i=1|L_i)} - \frac{I(A_i=0)}{g(A_i=0|L_i)}\)</span></span> <span class="citation"><span class="citation">(<a href="#ref-luque2018targeted" role="doc-biblioref">Luque-Fernandez et al. 2018</a>)</span></span>
</p>
</div>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="tmle.html#cb233-1" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>H.A1L <span class="ot">&lt;-</span> (ObsData<span class="sc">$</span>A) <span class="sc">/</span> ObsData<span class="sc">$</span>PS.SL </span>
<span id="cb233-2"><a href="tmle.html#cb233-2" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>H.A0L <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>ObsData<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span><span class="sc">-</span> ObsData<span class="sc">$</span>PS.SL)</span>
<span id="cb233-3"><a href="tmle.html#cb233-3" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>H.AL <span class="ot">&lt;-</span> ObsData<span class="sc">$</span>H.A1L <span class="sc">-</span> ObsData<span class="sc">$</span>H.A0L</span>
<span id="cb233-4"><a href="tmle.html#cb233-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>H.AL)</span></code></pre></div>
<pre><code>##        V1         
##  Min.   :-7.4954  
##  1st Qu.:-1.2922  
##  Median :-1.0659  
##  Mean   :-0.1378  
##  3rd Qu.: 1.3662  
##  Max.   :26.7017</code></pre>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="tmle.html#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tapply</span>(ObsData<span class="sc">$</span>H.AL, ObsData<span class="sc">$</span>A, summary)</span></code></pre></div>
<pre><code>## $`0`
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  -7.495  -1.487  -1.215  -1.377  -1.087  -1.003 
## 
## $`1`
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.017   1.278   1.529   1.878   2.039  26.702</code></pre>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="tmle.html#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">apply</span>(<span class="fu">cbind</span>(<span class="sc">-</span>ObsData<span class="sc">$</span>H.A0L,ObsData<span class="sc">$</span>H.A1L), </span>
<span id="cb237-2"><a href="tmle.html#cb237-2" aria-hidden="true" tabindex="-1"></a>      <span class="dv">2</span>, summary)) </span></code></pre></div>
<pre><code>##           Min.   1st Qu.    Median       Mean  3rd Qu.    Max.
## [1,] -7.495399 -1.292187 -1.065943 -0.8527551 0.000000  0.0000
## [2,]  0.000000  0.000000  0.000000  0.7150032 1.366217 26.7017</code></pre>
<p>Aggregated or individual clever covariate components show slight difference in their summaries.</p>
</div>
<div id="step-5-estimate-epsilon" class="section level2" number="6.8">
<h2><span class="header-section-number">6.8</span> Step 5: Estimate <span class="math inline">\(\epsilon\)</span></h2>
<div class="rmdcomment">
<p>
Fluctuation parameter <span class="math inline"><span class="math inline">\(\epsilon\)</span></span>, representing <strong>how large of an adjustment we will make</strong> to the initial estimate.
</p>
</div>
<ul>
<li><p>The fluctuation parameter <span class="math inline">\(\hat\epsilon\)</span> could be</p>
<ul>
<li>a scalar or</li>
<li>a vector with 2 components <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span>.</li>
</ul></li>
<li><p>It is estimated through MLE, using a model with an offset based on the initial estimate, and clever covariates as independent variables <span class="citation">(<a href="#ref-gruber2009targeted" role="doc-biblioref">Susan Gruber and Van Der Laan 2009</a>)</span>:</p>
<p><span class="math inline">\(E(Y|A,L)(\epsilon) = \frac{1}{1+\exp(-\log\frac{\bar Q^0(A,L)}{(1-\bar Q^0(A,L))}-\epsilon \times H(A,L))}\)</span></p></li>
</ul>
<div id="hatepsilon-hatepsilon_0-and-hatepsilon_1" class="section level3" number="6.8.1">
<h3><span class="header-section-number">6.8.1</span> <span class="math inline">\(\hat\epsilon\)</span> = <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span></h3>
<p>This is closer to how <code>tmle</code> package has implement clever covariates</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="tmle.html#cb239-1" aria-hidden="true" tabindex="-1"></a>eps_mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y.bounded <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> H.A1L <span class="sc">+</span> H.A0L <span class="sc">+</span>  </span>
<span id="cb239-2"><a href="tmle.html#cb239-2" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">offset</span>(<span class="fu">qlogis</span>(init.Pred)), </span>
<span id="cb239-3"><a href="tmle.html#cb239-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb239-4"><a href="tmle.html#cb239-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> ObsData)</span>
<span id="cb239-5"><a href="tmle.html#cb239-5" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">coef</span>(eps_mod)  </span>
<span id="cb239-6"><a href="tmle.html#cb239-6" aria-hidden="true" tabindex="-1"></a>epsilon[<span class="st">&quot;H.A1L&quot;</span>]</span></code></pre></div>
<pre><code>##      H.A1L 
## 0.01568809</code></pre>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="tmle.html#cb241-1" aria-hidden="true" tabindex="-1"></a>epsilon[<span class="st">&quot;H.A0L&quot;</span>] </span></code></pre></div>
<pre><code>##      H.A0L 
## 0.02070037</code></pre>
<p>Note that, if <code>init.Pred</code> includes negative values, <code>NaNs</code> would be produced after applying <code>qlogis()</code>.</p>
</div>
<div id="only-1-hatepsilon" class="section level3" number="6.8.2">
<h3><span class="header-section-number">6.8.2</span> Only 1 <span class="math inline">\(\hat\epsilon\)</span></h3>
<p>For demonstration purposes</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="tmle.html#cb243-1" aria-hidden="true" tabindex="-1"></a>eps_mod1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y.bounded <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> H.AL <span class="sc">+</span></span>
<span id="cb243-2"><a href="tmle.html#cb243-2" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">offset</span>(<span class="fu">qlogis</span>(init.Pred)),</span>
<span id="cb243-3"><a href="tmle.html#cb243-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb243-4"><a href="tmle.html#cb243-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> ObsData)</span>
<span id="cb243-5"><a href="tmle.html#cb243-5" aria-hidden="true" tabindex="-1"></a>epsilon1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(eps_mod1) </span>
<span id="cb243-6"><a href="tmle.html#cb243-6" aria-hidden="true" tabindex="-1"></a>epsilon1 </span></code></pre></div>
<pre><code>##        H.AL 
## 0.001845536</code></pre>
<p>Alternative could be to use <code>H.AL</code> as weights (not shown here).</p>
</div>
</div>
<div id="step-6-update" class="section level2" number="6.9">
<h2><span class="header-section-number">6.9</span> Step 6: Update</h2>
<div id="hatepsilon-hatepsilon_0-and-hatepsilon_1-1" class="section level3" number="6.9.1">
<h3><span class="header-section-number">6.9.1</span> <span class="math inline">\(\hat\epsilon\)</span> = <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span></h3>
<p>We can use <code>epsilon["H.A1L"]</code> and <code>epsilon["H.A0L"]</code> to update</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="tmle.html#cb245-1" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>Pred.Y1.update <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">qlogis</span>(ObsData<span class="sc">$</span>Pred.Y1) <span class="sc">+</span>  </span>
<span id="cb245-2"><a href="tmle.html#cb245-2" aria-hidden="true" tabindex="-1"></a>                                   epsilon[<span class="st">&quot;H.A1L&quot;</span>]<span class="sc">*</span>ObsData<span class="sc">$</span>H.A1L)</span>
<span id="cb245-3"><a href="tmle.html#cb245-3" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>Pred.Y0.update <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">qlogis</span>(ObsData<span class="sc">$</span>Pred.Y0) <span class="sc">+</span> </span>
<span id="cb245-4"><a href="tmle.html#cb245-4" aria-hidden="true" tabindex="-1"></a>                                   epsilon[<span class="st">&quot;H.A0L&quot;</span>]<span class="sc">*</span>ObsData<span class="sc">$</span>H.A0L)</span>
<span id="cb245-5"><a href="tmle.html#cb245-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>Pred.Y1.update)</span></code></pre></div>
<pre><code>##        V1          
##  Min.   :0.001031  
##  1st Qu.:0.042745  
##  Median :0.054882  
##  Mean   :0.053810  
##  3rd Qu.:0.065188  
##  Max.   :0.139189</code></pre>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="tmle.html#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>Pred.Y0.update)  </span></code></pre></div>
<pre><code>##        V1         
##  Min.   :0.00100  
##  1st Qu.:0.03603  
##  Median :0.04779  
##  Mean   :0.04686  
##  3rd Qu.:0.05809  
##  Max.   :0.12652</code></pre>
</div>
<div id="only-1-hatepsilon-1" class="section level3" number="6.9.2">
<h3><span class="header-section-number">6.9.2</span> Only 1 <span class="math inline">\(\hat\epsilon\)</span></h3>
<p>Alternatively, we could use <code>epsilon</code> to from <code>H.AL</code> to update</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="tmle.html#cb249-1" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>Pred.Y1.update1 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">qlogis</span>(ObsData<span class="sc">$</span>Pred.Y1) <span class="sc">+</span>  </span>
<span id="cb249-2"><a href="tmle.html#cb249-2" aria-hidden="true" tabindex="-1"></a>                                   epsilon1<span class="sc">*</span>ObsData<span class="sc">$</span>H.AL)</span>
<span id="cb249-3"><a href="tmle.html#cb249-3" aria-hidden="true" tabindex="-1"></a>ObsData<span class="sc">$</span>Pred.Y0.update1 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">qlogis</span>(ObsData<span class="sc">$</span>Pred.Y0) <span class="sc">+</span> </span>
<span id="cb249-4"><a href="tmle.html#cb249-4" aria-hidden="true" tabindex="-1"></a>                                   epsilon1<span class="sc">*</span>ObsData<span class="sc">$</span>H.AL)</span>
<span id="cb249-5"><a href="tmle.html#cb249-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>Pred.Y1.update1)</span></code></pre></div>
<pre><code>##        V1          
##  Min.   :0.001004  
##  1st Qu.:0.042323  
##  Median :0.054282  
##  Mean   :0.053210  
##  3rd Qu.:0.064424  
##  Max.   :0.136895</code></pre>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="tmle.html#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ObsData<span class="sc">$</span>Pred.Y0.update1)   </span></code></pre></div>
<pre><code>##        V1          
##  Min.   :0.001004  
##  1st Qu.:0.035254  
##  Median :0.047066  
##  Mean   :0.046077  
##  3rd Qu.:0.057296  
##  Max.   :0.126804</code></pre>
<p>Note that, if <code>Pred.Y1</code> and <code>Pred.Y0</code> include negative values, <code>NaNs</code> would be produced after applying <code>qlogis()</code>.</p>
</div>
</div>
<div id="step-7-effect-estimate" class="section level2" number="6.10">
<h2><span class="header-section-number">6.10</span> Step 7: Effect estimate</h2>
<p>Now that the updated predictions of our outcome models are calculated, we can calculate the ATE.</p>
<div id="hatepsilon-hatepsilon_0-and-hatepsilon_1-2" class="section level3" number="6.10.1">
<h3><span class="header-section-number">6.10.1</span> <span class="math inline">\(\hat\epsilon\)</span> = <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span></h3>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="tmle.html#cb253-1" aria-hidden="true" tabindex="-1"></a>ATE.TMLE.bounded.vector <span class="ot">&lt;-</span> ObsData<span class="sc">$</span>Pred.Y1.update <span class="sc">-</span>  </span>
<span id="cb253-2"><a href="tmle.html#cb253-2" aria-hidden="true" tabindex="-1"></a>                           ObsData<span class="sc">$</span>Pred.Y0.update</span>
<span id="cb253-3"><a href="tmle.html#cb253-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ATE.TMLE.bounded.vector) </span></code></pre></div>
<pre><code>##        V1           
##  Min.   :-0.011371  
##  1st Qu.: 0.005740  
##  Median : 0.006569  
##  Mean   : 0.006954  
##  3rd Qu.: 0.008228  
##  Max.   : 0.031895</code></pre>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="tmle.html#cb255-1" aria-hidden="true" tabindex="-1"></a>ATE.TMLE.bounded <span class="ot">&lt;-</span> <span class="fu">mean</span>(ATE.TMLE.bounded.vector, </span>
<span id="cb255-2"><a href="tmle.html#cb255-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb255-3"><a href="tmle.html#cb255-3" aria-hidden="true" tabindex="-1"></a>ATE.TMLE.bounded </span></code></pre></div>
<pre><code>## [1] 0.006953925</code></pre>
</div>
<div id="only-1-hatepsilon-2" class="section level3" number="6.10.2">
<h3><span class="header-section-number">6.10.2</span> Only 1 <span class="math inline">\(\hat\epsilon\)</span></h3>
<p>Alternatively, using <code>H.AL</code>:</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="tmle.html#cb257-1" aria-hidden="true" tabindex="-1"></a>ATE.TMLE.bounded.vector1 <span class="ot">&lt;-</span> ObsData<span class="sc">$</span>Pred.Y1.update1 <span class="sc">-</span>  </span>
<span id="cb257-2"><a href="tmle.html#cb257-2" aria-hidden="true" tabindex="-1"></a>                           ObsData<span class="sc">$</span>Pred.Y0.update1</span>
<span id="cb257-3"><a href="tmle.html#cb257-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ATE.TMLE.bounded.vector1) </span></code></pre></div>
<pre><code>##        V1           
##  Min.   :-0.010315  
##  1st Qu.: 0.006681  
##  Median : 0.007066  
##  Mean   : 0.007133  
##  3rd Qu.: 0.007540  
##  Max.   : 0.021637</code></pre>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="tmle.html#cb259-1" aria-hidden="true" tabindex="-1"></a>ATE.TMLE.bounded1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(ATE.TMLE.bounded.vector1, </span>
<span id="cb259-2"><a href="tmle.html#cb259-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb259-3"><a href="tmle.html#cb259-3" aria-hidden="true" tabindex="-1"></a>ATE.TMLE.bounded1 </span></code></pre></div>
<pre><code>## [1] 0.007132696</code></pre>
</div>
</div>
<div id="step-8-rescale-effect-estimate" class="section level2" number="6.11">
<h2><span class="header-section-number">6.11</span> Step 8: Rescale effect estimate</h2>
<p>We make sure to transform back to our original scale.</p>
<div id="hatepsilon-hatepsilon_0-and-hatepsilon_1-3" class="section level3" number="6.11.1">
<h3><span class="header-section-number">6.11.1</span> <span class="math inline">\(\hat\epsilon\)</span> = <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span></h3>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="tmle.html#cb261-1" aria-hidden="true" tabindex="-1"></a>ATE.TMLE <span class="ot">&lt;-</span> (max.Y<span class="sc">-</span>min.Y)<span class="sc">*</span>ATE.TMLE.bounded   </span>
<span id="cb261-2"><a href="tmle.html#cb261-2" aria-hidden="true" tabindex="-1"></a>ATE.TMLE </span></code></pre></div>
<pre><code>## [1] 2.725938</code></pre>
</div>
<div id="only-1-hatepsilon-3" class="section level3" number="6.11.2">
<h3><span class="header-section-number">6.11.2</span> Only 1 <span class="math inline">\(\hat\epsilon\)</span></h3>
<p>Alternatively, using <code>H.AL</code>:</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="tmle.html#cb263-1" aria-hidden="true" tabindex="-1"></a>ATE.TMLE1 <span class="ot">&lt;-</span> (max.Y<span class="sc">-</span>min.Y)<span class="sc">*</span>ATE.TMLE.bounded1</span>
<span id="cb263-2"><a href="tmle.html#cb263-2" aria-hidden="true" tabindex="-1"></a>ATE.TMLE1 </span></code></pre></div>
<pre><code>## [1] 2.796017</code></pre>
</div>
</div>
<div id="step-9-confidence-interval-estimation" class="section level2" number="6.12">
<h2><span class="header-section-number">6.12</span> Step 9: Confidence interval estimation</h2>
<ul>
<li>Since the machine learning algorithms were used only in intermediary steps, rather than estimating our parameter of interest directly, 95% confidence intervals can be calculated directly <span class="citation">(<a href="#ref-luque2018targeted" role="doc-biblioref">Luque-Fernandez et al. 2018</a>)</span>.</li>
</ul>
<div class="rmdcomment">
<p>
Based on semi-parametric theory, closed form variance formula is already derived <span class="citation"><span class="citation">(<a href="#ref-van2012targeted" role="doc-biblioref">Laan and Petersen 2012</a>)</span></span>.
</p>
</div>
<ul>
<li>Time-consuming bootstrap procedure is not necessary.</li>
</ul>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="tmle.html#cb265-1" aria-hidden="true" tabindex="-1"></a>ci.estimate <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">data =</span> ObsData, <span class="at">H.AL.components =</span> <span class="dv">1</span>){</span>
<span id="cb265-2"><a href="tmle.html#cb265-2" aria-hidden="true" tabindex="-1"></a>  min.Y <span class="ot">&lt;-</span> <span class="fu">min</span>(data<span class="sc">$</span>Y)</span>
<span id="cb265-3"><a href="tmle.html#cb265-3" aria-hidden="true" tabindex="-1"></a>  max.Y <span class="ot">&lt;-</span> <span class="fu">max</span>(data<span class="sc">$</span>Y)</span>
<span id="cb265-4"><a href="tmle.html#cb265-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transform predicted outcomes back to original scale</span></span>
<span id="cb265-5"><a href="tmle.html#cb265-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (H.AL.components <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb265-6"><a href="tmle.html#cb265-6" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>Pred.Y1.update.rescaled <span class="ot">&lt;-</span> </span>
<span id="cb265-7"><a href="tmle.html#cb265-7" aria-hidden="true" tabindex="-1"></a>      (max.Y<span class="sc">-</span> min.Y)<span class="sc">*</span>data<span class="sc">$</span>Pred.Y1.update <span class="sc">+</span> min.Y</span>
<span id="cb265-8"><a href="tmle.html#cb265-8" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>Pred.Y0.update.rescaled <span class="ot">&lt;-</span> </span>
<span id="cb265-9"><a href="tmle.html#cb265-9" aria-hidden="true" tabindex="-1"></a>      (max.Y<span class="sc">-</span> min.Y)<span class="sc">*</span>data<span class="sc">$</span>Pred.Y0.update <span class="sc">+</span> min.Y</span>
<span id="cb265-10"><a href="tmle.html#cb265-10" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb265-11"><a href="tmle.html#cb265-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (H.AL.components <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb265-12"><a href="tmle.html#cb265-12" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>Pred.Y1.update.rescaled <span class="ot">&lt;-</span> </span>
<span id="cb265-13"><a href="tmle.html#cb265-13" aria-hidden="true" tabindex="-1"></a>      (max.Y<span class="sc">-</span> min.Y)<span class="sc">*</span>data<span class="sc">$</span>Pred.Y1.update1 <span class="sc">+</span> min.Y</span>
<span id="cb265-14"><a href="tmle.html#cb265-14" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>Pred.Y0.update.rescaled <span class="ot">&lt;-</span> </span>
<span id="cb265-15"><a href="tmle.html#cb265-15" aria-hidden="true" tabindex="-1"></a>      (max.Y<span class="sc">-</span> min.Y)<span class="sc">*</span>data<span class="sc">$</span>Pred.Y0.update1 <span class="sc">+</span> min.Y</span>
<span id="cb265-16"><a href="tmle.html#cb265-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb265-17"><a href="tmle.html#cb265-17" aria-hidden="true" tabindex="-1"></a>  EY1_TMLE1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>Pred.Y1.update.rescaled, </span>
<span id="cb265-18"><a href="tmle.html#cb265-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb265-19"><a href="tmle.html#cb265-19" aria-hidden="true" tabindex="-1"></a>  EY0_TMLE1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>Pred.Y0.update.rescaled, </span>
<span id="cb265-20"><a href="tmle.html#cb265-20" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb265-21"><a href="tmle.html#cb265-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ATE efficient influence curve</span></span>
<span id="cb265-22"><a href="tmle.html#cb265-22" aria-hidden="true" tabindex="-1"></a>  D1 <span class="ot">&lt;-</span> data<span class="sc">$</span>A<span class="sc">/</span>data<span class="sc">$</span>PS.SL<span class="sc">*</span></span>
<span id="cb265-23"><a href="tmle.html#cb265-23" aria-hidden="true" tabindex="-1"></a>    (data<span class="sc">$</span>Y <span class="sc">-</span> data<span class="sc">$</span>Pred.Y1.update.rescaled) <span class="sc">+</span> </span>
<span id="cb265-24"><a href="tmle.html#cb265-24" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>Pred.Y1.update.rescaled <span class="sc">-</span> EY1_TMLE1</span>
<span id="cb265-25"><a href="tmle.html#cb265-25" aria-hidden="true" tabindex="-1"></a>  D0 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>A)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>PS.SL)<span class="sc">*</span></span>
<span id="cb265-26"><a href="tmle.html#cb265-26" aria-hidden="true" tabindex="-1"></a>    (data<span class="sc">$</span>Y <span class="sc">-</span> data<span class="sc">$</span>Pred.Y0.update.rescaled) <span class="sc">+</span> </span>
<span id="cb265-27"><a href="tmle.html#cb265-27" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>Pred.Y0.update.rescaled <span class="sc">-</span> EY0_TMLE1</span>
<span id="cb265-28"><a href="tmle.html#cb265-28" aria-hidden="true" tabindex="-1"></a>  EIC <span class="ot">&lt;-</span> D1 <span class="sc">-</span> D0</span>
<span id="cb265-29"><a href="tmle.html#cb265-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ATE variance</span></span>
<span id="cb265-30"><a href="tmle.html#cb265-30" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb265-31"><a href="tmle.html#cb265-31" aria-hidden="true" tabindex="-1"></a>  varHat.IC <span class="ot">&lt;-</span> <span class="fu">var</span>(EIC, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">/</span>n</span>
<span id="cb265-32"><a href="tmle.html#cb265-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ATE 95% CI</span></span>
<span id="cb265-33"><a href="tmle.html#cb265-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (H.AL.components <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb265-34"><a href="tmle.html#cb265-34" aria-hidden="true" tabindex="-1"></a>    ATE.TMLE.CI <span class="ot">&lt;-</span> <span class="fu">c</span>(ATE.TMLE <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span><span class="fu">sqrt</span>(varHat.IC), </span>
<span id="cb265-35"><a href="tmle.html#cb265-35" aria-hidden="true" tabindex="-1"></a>                   ATE.TMLE <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span><span class="fu">sqrt</span>(varHat.IC))</span>
<span id="cb265-36"><a href="tmle.html#cb265-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb265-37"><a href="tmle.html#cb265-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (H.AL.components <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb265-38"><a href="tmle.html#cb265-38" aria-hidden="true" tabindex="-1"></a>    ATE.TMLE.CI <span class="ot">&lt;-</span> <span class="fu">c</span>(ATE.TMLE1 <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span><span class="fu">sqrt</span>(varHat.IC), </span>
<span id="cb265-39"><a href="tmle.html#cb265-39" aria-hidden="true" tabindex="-1"></a>                   ATE.TMLE1 <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span><span class="fu">sqrt</span>(varHat.IC))</span>
<span id="cb265-40"><a href="tmle.html#cb265-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb265-41"><a href="tmle.html#cb265-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ATE.TMLE.CI) </span>
<span id="cb265-42"><a href="tmle.html#cb265-42" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div id="hatepsilon-hatepsilon_0-and-hatepsilon_1-4" class="section level3" number="6.12.1">
<h3><span class="header-section-number">6.12.1</span> <span class="math inline">\(\hat\epsilon\)</span> = <span class="math inline">\(\hat\epsilon_0\)</span> and <span class="math inline">\(\hat\epsilon_1\)</span></h3>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="tmle.html#cb266-1" aria-hidden="true" tabindex="-1"></a>CI2 <span class="ot">&lt;-</span> <span class="fu">ci.estimate</span>(<span class="at">data =</span> ObsData, <span class="at">H.AL.components =</span> <span class="dv">2</span>) </span>
<span id="cb266-2"><a href="tmle.html#cb266-2" aria-hidden="true" tabindex="-1"></a>CI2</span></code></pre></div>
<pre><code>## [1] 1.585188 3.866689</code></pre>
</div>
<div id="only-1-hatepsilon-4" class="section level3" number="6.12.2">
<h3><span class="header-section-number">6.12.2</span> Only 1 <span class="math inline">\(\hat\epsilon\)</span></h3>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="tmle.html#cb268-1" aria-hidden="true" tabindex="-1"></a>CI1 <span class="ot">&lt;-</span> <span class="fu">ci.estimate</span>(<span class="at">data =</span> ObsData, <span class="at">H.AL.components =</span> <span class="dv">1</span>) </span>
<span id="cb268-2"><a href="tmle.html#cb268-2" aria-hidden="true" tabindex="-1"></a>CI1</span></code></pre></div>
<pre><code>## [1] 1.654637 3.937396</code></pre>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="tmle.html#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ATE.TMLE, <span class="at">file =</span> <span class="st">&quot;data/tmlepointh.RDS&quot;</span>) </span>
<span id="cb270-2"><a href="tmle.html#cb270-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(CI2, <span class="at">file =</span> <span class="st">&quot;data/tmlecih.RDS&quot;</span>)</span></code></pre></div>

<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="tmle.html#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the data saved at the last chapter</span></span>
<span id="cb271-2"><a href="tmle.html#cb271-2" aria-hidden="true" tabindex="-1"></a>ObsData <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">&quot;data/rhcAnalytic.RDS&quot;</span>)</span>
<span id="cb271-3"><a href="tmle.html#cb271-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(ObsData)</span></code></pre></div>
<pre><code>## [1] 5735   51</code></pre>
</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-gruber2010targeted" class="csl-entry">
Gruber, Susan, and Mark J van der Laan. 2010. <span>“A Targeted Maximum Likelihood Estimator of a Causal Effect on a Bounded Continuous Outcome.”</span> <em>The International Journal of Biostatistics</em> 6 (1).
</div>
<div id="ref-gruber2009targeted" class="csl-entry">
Gruber, Susan, and Mark J Van Der Laan. 2009. <span>“Targeted Maximum Likelihood Estimation: A Gentle Introduction.”</span>
</div>
<div id="ref-van2012targeted" class="csl-entry">
Laan, Mark J van der, and Maya L Petersen. 2012. <em>Targeted Learning</em>. NY: Springer.
</div>
<div id="ref-luque2018targeted" class="csl-entry">
Luque-Fernandez, Miguel Angel, Michael Schomaker, Bernard Rachet, and Mireille E Schnitzer. 2018. <span>“Targeted Maximum Likelihood Estimation for a Binary Treatment: A Tutorial.”</span> <em>Statistics in Medicine</em> 37 (16): 2530–46.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="iptw-using-ml.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="pre-packaged-software.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ehsanx/TMLEworkshop/edit/master/4tmle.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["TMLEw.pdf", "TMLEw.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
